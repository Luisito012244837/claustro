<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Trabajador</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/css/estilo insertar.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Estilos para el formulario */
        .form-container {
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        .form-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .form-label {
            font-weight: bold;
            color: #333;
        }
        .card {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .card-body {
            padding: 20px;
        }
        .select2 {
            width: 100% !important;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Editar Trabajador</h2>
        <form id="formEditarTrabajador">
            <!-- Primera fila de 4 campos -->
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="username"><strong>Nombre</strong></label>
                        <input class="form-control" type="text" id="username" placeholder="Nombre" name="username" required>
                        <div class="invalid-feedback">Por favor, ingresa un nombre válido.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="primerApellido"><strong>Primer Apellido</strong></label>
                        <input class="form-control" type="text" id="primerApellido" placeholder="Primer Apellido" name="primerApellido" required>
                        <div class="invalid-feedback">Por favor, ingresa un apellido válido.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="segundoApellido"><strong>Segundo Apellido</strong></label>
                        <input class="form-control" type="text" id="segundoApellido" placeholder="Segundo Apellido" name="segundoApellido" required>
                        <div class="invalid-feedback">Por favor, ingresa un apellido válido.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="group_count"><strong>Cant_Grup_Conferencia</strong></label>
                        <input class="form-control" type="number" id="group_count" placeholder="Cantidad de grupos" name="group_count" required min="1" max="9">
                        <div class="invalid-feedback">Por favor, ingresa un número válido menor que 10.</div>
                    </div>
                </div>
            </div>

            <!-- Segunda fila de 4 campos -->
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="group_count_practica"><strong>Cant_Grup_Clase_Práctica</strong></label>
                        <input class="form-control" type="number" id="group_count_practica" placeholder="Cantidad de grupos" name="group_count_practica" required min="1" max="9">
                        <div class="invalid-feedback">Por favor, ingresa un número válido.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="year_graduated"><strong>Año Graduado</strong></label>
                        <input class="form-control" type="number" id="year_graduated" placeholder="Ingrese año" name="year_graduated" required>
                        <div class="invalid-feedback">Por favor, ingresa un año de graduación válido.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="experience_years"><strong>Años de experiencia</strong></label>
                        <input class="form-control" type="number" id="experience_years" placeholder="Años de experiencia" name="experience_years" required>
                        <div class="invalid-feedback">Por favor, ingresa un valor válido.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="sexo"><strong>Sexo</strong></label>
                        <select class="form-control" id="sexo" name="sexo" required>
                            <option value="" selected disabled hidden>Género</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Femenino">Femenino</option>
                        </select>
                        <div class="invalid-feedback">Por favor, selecciona un sexo.</div>
                    </div>
                </div>
            </div>

            <!-- Tercera fila de 4 campos -->
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="course" style="color: rgb(27, 22, 22);"><strong>Curso que imparte</strong></label>
                        <select class="form-control select2" id="course" name="course"  multiple="multiple" style="background-color: black;" required>
                         
                        </select>
                        <div class="invalid-feedback">Por favor, selecciona un curso.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="categoriaDocente"><strong>Categoría Docente</strong></label>
                        <select class="form-control select2" id="categoriaDocente" name="categoriaDocente" multiple="multiple" required>
                           
                        </select>
                        <div class="invalid-feedback">Por favor, selecciona al menos una categoría.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="anioAcademico"><strong>Año Académico</strong></label>
                        <select class="form-control select2" id="anioAcademico" name="anioAcademico" multiple="multiple" required>
                           
                        </select>
                        <div class="invalid-feedback">Por favor, selecciona al menos un año académico.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="career"><strong>Carrera</strong></label>
                        <select class="form-control select2" id="career" name="career" multiple="multiple" required>
                           
                        </select>
                        <div class="invalid-feedback">Por favor, selecciona al menos una carrera.</div>
                    </div>
                </div>
            </div>

            <!-- Cuarta fila de 4 campos -->
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="responsabilidad"><strong>Responsabilidad</strong></label>
                        <select class="form-control select2" id="responsabilidad" name="responsabilidad" multiple="multiple" required>
                           
                        </select>
                        <div class="invalid-feedback">Por favor, selecciona al menos una responsabilidad.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="cargo"><strong>Cargo</strong></label>
                        <select class="form-control select2" id="cargo" name="cargo" multiple="multiple" required>
                           
                        </select>
                        <div class="invalid-feedback">Por favor, selecciona al menos un cargo.</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label" for="categoriaCientifica"><strong>Categoría Científica</strong></label>
                        <select class="form-control select2" id="categoriaCientifica" name="categoriaCientifica" multiple="multiple" required>
                            
                        </select>
                        <div class="invalid-feedback">Por favor, selecciona una categoría científica.</div>
                    </div>
                </div>
            </div>

            <!-- Áreas y asignaturas -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 toggle-button"><strong>Asignatura</strong></h6>
                        </div>
                        <div class="card-body p-3">
                            <select class="form-control select2" id="asignaturaList" name="asignaturaList" multiple="multiple" required>
                             
                            </select>
                            <div class="invalid-feedback">Por favor, selecciona al menos una asignatura.</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 toggle-button"><strong>Área</strong></h6>
                        </div>
                        <div class="card-body p-3">
                            <select class="form-control select2" id="areaList" name="areaList" multiple="multiple" required>
                                
                            </select>
                            <div class="invalid-feedback">Por favor, selecciona al menos un área.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="text-center mb-3">
                <button class="btn btn-primary btn-sm" type="submit">Guardar cambios</button>
            
                <button class="btn btn-danger btn-sm" type="button" onclick="window.location.href='index.html'">Cancelar</button>
            </div>
        </form>
    </div>

    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/theme.js"></script>
    <script src="assets/js/js.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/funcionrelleno.js"></script>

    <script>

         // Inicializar Select2 con checkboxes
         $(document).ready(function () {
            $('.select2').select2({
                placeholder: "Seleccionar", // Placeholder
                closeOnSelect: false, // No cerrar el dropdown al seleccionar una opción
                allowClear: true, // Permitir borrar selecciones
            });
    
            // Lógica para permitir solo una selección en categoriaCientifica
            $('#categoriaCientifica').on('change', function () {
                const opcionesSeleccionadas = $(this).val(); // Obtener las opciones seleccionadas
    
                // Si hay más de una opción seleccionada, deseleccionar las demás
                if (opcionesSeleccionadas && opcionesSeleccionadas.length > 1) {
                    $(this).val([opcionesSeleccionadas[opcionesSeleccionadas.length - 1]]).trigger('change'); // Mantener solo la última selección
                }
            });
        });
    

        // URL de la API (cambia esto por la URL real de tu API)
        const API_URL = "http://192.168.43.176:8000/apiv2/trabajador/";
    
        // Capturar el ID del trabajador desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const trabajadorId = urlParams.get('id_trabajador');
    
        // Función para obtener los datos del trabajador desde la API
        async function obtenerTrabajador(id_trabajador) {
            try {
                const response = await fetch(`${API_URL}/${id_trabajador}`);
                if (!response.ok) {
                    throw new Error(`Error: ${response.status} - ${response.statusText}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error al obtener los datos del trabajador:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo cargar la información del trabajador. Inténtalo de nuevo más tarde.',
                });
                return null;
            }
        }
    
        // Función para llenar el formulario con los datos del trabajador
        function llenarFormulario(trabajador) {
            if (!trabajador) return;
    
            // Llenar campos básicos
            document.getElementById('username').value = trabajador.nombre || '';
            document.getElementById('primerApellido').value = trabajador.primerApellido || '';
            document.getElementById('segundoApellido').value = trabajador.segundoApellido || '';
            document.getElementById('group_count').value = trabajador.cantGruposConferencia || '';
            document.getElementById('group_count_practica').value = trabajador.cantGruposPractica || '';
            document.getElementById('year_graduated').value = trabajador.anioGraduado || '';
            document.getElementById('experience_years').value = trabajador.aniosExperiencia || '';
            document.getElementById('sexo').value = trabajador.sexo || '';
    
            // Llenar selectores múltiples
            if (trabajador.course) {
                document.getElementById('course').value = trabajador.course .split(',');
            }
            if (trabajador.categoriaDocente) {
                document.getElementById('categoriaDocente').value = trabajador.categoriaDocente.split(',');
            }
            if (trabajador.anioAcademico) {
                document.getElementById('anioAcademico').value = trabajador.anioAcademico.split(',');
            }
            if (trabajador.carrera) {
                document.getElementById('career').value = trabajador.carrera.split(',');
            }
            if (trabajador.responsabilidad) {
                document.getElementById('responsabilidad').value = trabajador.responsabilidad .split(',');
            }
            if (trabajador.cargo) {
                document.getElementById('cargo').value = trabajador.cargo .split(',');
            }
            if (trabajador.categoriaCientifica) {
                document.getElementById('categoriaCientifica').value = trabajador.categoriaCientifica .split(',');
            }
             if (trabajador.asignaturas) {
                document.getElementById('asignaturaList').value = trabajador.asignaturas.split(',');
            }
            if (trabajador.areas) {
                document.getElementById('areaList').value = trabajador.areas.split(',');
            }
        }
    
        // Función principal para cargar los datos del trabajador
        async function cargarDatosTrabajador() {
            if (!trabajadorId) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Advertencia',
                    text: 'No se proporcionó un ID de trabajador válido.',
                });
                return;
            }
    
            const trabajador = await obtenerTrabajador(id_trabajador);
            if (trabajador) {
                llenarFormulario(trabajador);
            }
        }
    
        // Llamar a la función principal al cargar la página
        document.addEventListener('DOMContentLoaded', cargarDatosTrabajador);
    
        // Manejar el envío del formulario
        document.getElementById('formEditarTrabajador').addEventListener('submit', async (event) => {
            event.preventDefault();
    
            // Obtener los datos del formulario
            const formData = new FormData(event.target);
            const datosActualizados = Object.fromEntries(formData.entries());
    
            try {
                const response = await fetch(`${API_URL}/${id_trabajador}`, {
                    method: 'PUT', // Método HTTP para actualizar
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datosActualizados),
                });
    
                if (!response.ok) {
                    throw new Error(`Error: ${response.status} - ${response.statusText}`);
                }
    
                const resultado = await response.json();
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: 'Trabajador actualizado correctamente.',
                });
                console.log("Respuesta del servidor:", resultado);
            } catch (error) {
                console.error("Error al actualizar el trabajador:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo actualizar el trabajador. Inténtalo de nuevo más tarde.',
                });
            }
        });
    </script>
</body>
</html>